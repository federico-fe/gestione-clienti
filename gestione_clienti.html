<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clienti con Dropbox Sync</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="container py-4">
  <h2>Clienti e Reminder (sincronizzati su Dropbox)</h2>

  <form id="clienteForm" class="my-3">
    <input type="text" id="nomeCliente" placeholder="Nome cliente" class="form-control mb-2" required>
    <input type="text" id="aziendaCliente" placeholder="Azienda" class="form-control mb-2" required>
    <input type="text" id="oggettoIncontro" placeholder="Oggetto incontro" class="form-control mb-2" required>
    <input type="date" id="dataIncontro" class="form-control mb-2" required>

    <select id="eisenhower" class="form-select mb-2">
      <option value="UI">Urgente e Importante</option>
      <option value="UNI">Urgente ma Non Importante</option>
      <option value="NUI">Non Urgente ma Importante</option>
      <option value="NUNI">Non Urgente e Non Importante</option>
    </select>

    <button type="submit" class="btn btn-primary">Salva cliente</button>
  </form>

  <input type="text" id="ricerca" placeholder="Ricerca per nome o azienda..." class="form-control mb-3">
  <select id="filtroEisenhower" class="form-select mb-3">
    <option value="TUTTI">Tutte le priorit√†</option>
    <option value="UI">Urgente e Importante</option>
    <option value="UNI">Urgente ma Non Importante</option>
    <option value="NUI">Non Urgente ma Importante</option>
    <option value="NUNI">Non Urgente e Non Importante</option>
  </select>

  <h4>Clienti registrati</h4>
  <ul id="listaClienti" class="list-group"></ul>
</div>

<script>
const DROPBOX_TOKEN = 'sl.u.AF15CJOqwxnUw-XeXWyLAq2WT_ZOWeuYcfkOfDlAt3YrSinrtIr9bMzJrIpJMgKWSa-IO9eW5Mv2O6dAprcAQ_WhlTBKVGYA9sTHsxJfpXcvF3tkv6O7oeQI0kXTAUoMaLIaqUcKYlPpXWFkAJoTRvAeNi_c9vDtMZsibnl8Px8ERiue1DP-_aO-rXhatG-Bw8_cSl69HXx-_tuq5E2NXDF_1OYpkt6fHyS8lATD2qJkMse6-KFwVFqVyEotCdh6Pw2WGNdb3TDjmwj9n_shX5YvesYmvMY4iJT-XWITuC8CX9gAaexoXWlo0b7la3ZJM6e0KqlZSrFd9nPiP_E2mIEAtm9bBaoKkVFYfR6qZ114CPBwjZPWRt4Mt5neclSz2Ux8gS6N4cEJ6jXDorIhzRuN5iizdtIBA4rPB8cWsAcPED0zgqCFcIDKfpCYagfqeEol0YWSEFPSiFYXrSonLhaCoDQHzQT5DNQyNC2zc84KrFZAz_1AJN_Bb-XBrv-K6axE7_HlXnMZX2DL8aX5mkCIw_m5b14esvuqCmrdiYWC6AsD1zP-KFc_RvtBYu3wpjsRb5ed_pQ_DHe0E3T3RbMyPDHLZ-lpFLfeWY1hbvWv3dVXT9APwI4gEBKdKEgQuoYQCTnkW5soJqHT9ZDghEMTLknV2iy3-ISKwf_QBwOE_pO589leZnOEZy7SZmI_I9TL2VRL1yZ6OaRWVpjGxz6Woj0H6QYB43MCIEu4yT6TB_ojOaZNzz4ZHwrPhMNBD3ya8EHrhmt4LNdSbMIFauhThvc9r_005NvgVKTwsRqLEVkWVuKlfTxq6T23dRhN6HGDhM4RQNt1evH_8tdV5PIU0v7IJRPFRi4qfzItrTZBjLcpCSdEKMzq97PM7VIHjHDOtSkYZTCYvKlQGPtku1tP5RzSpoDNfZ3ylTN9QNgDJsU-fcuQVvK5SbdlTTTC_Zv2w4ddayjP2Gb-2QfcXsLFOal43YbR_1BNZpWt_tGZ4QaCUMDHKMNwDEWH8odFw9HvHz5Z6l0TOTXRsHgS1X_C80g55x_kKv0AncGOJcClOXdan7KgJ2t4FAKxtJWoSwCO17q01LDuftuOoKifxalG3ehoZwqkjjb2YuWuhMjrOp4mTvRd84EsiRPxnCEVHq3_YDaSzMYe4jl3pqicK-mOh9kZLX8y47AgxM28awS3_D7tBu3wa55_aiV7Xe1-x2gngnpmOi6fEqqaC1569QnJvGduBMBGizWU02GbmB9ocpCj2Brtw1rpynBuNt_smfjKyOABPitLC0_-tfaSvNIZpWugnU45iYAIQcSaqdV6Mg';
const FILE_PATH = '/clienti.json';
let clienti = [];

async function caricaClienti() {
  try {
    const res = await axios.post('https://content.dropboxapi.com/2/files/download', null, {
      headers: {
        Authorization: 'Bearer ' + DROPBOX_TOKEN,
        'Dropbox-API-Arg': JSON.stringify({ path: FILE_PATH })
      }
    });
    clienti = JSON.parse(res.data);
    aggiornaLista();
  } catch (err) {
    if (err.response && err.response.status === 409) clienti = []; // file non esiste
    else alert('Errore nel caricamento dati da Dropbox');
  }
}

async function salvaClienti() {
  try {
    await axios.post('https://content.dropboxapi.com/2/files/upload', JSON.stringify(clienti), {
      headers: {
        Authorization: 'Bearer ' + DROPBOX_TOKEN,
        'Content-Type': 'application/octet-stream',
        'Dropbox-API-Arg': JSON.stringify({ path: FILE_PATH, mode: 'overwrite' })
      }
    });
  } catch (err) {
    alert('Errore nel salvataggio su Dropbox');
  }
}

function aggiornaLista() {
  const ricerca = document.getElementById('ricerca').value.toLowerCase();
  const filtro = document.getElementById('filtroEisenhower').value;
  const lista = document.getElementById('listaClienti');
  lista.innerHTML = '';
  clienti.forEach((cliente, index) => {
    if ((cliente.nome.toLowerCase().includes(ricerca) || cliente.azienda.toLowerCase().includes(ricerca)) &&
        (filtro === 'TUTTI' || cliente.eisenhower === filtro)) {
      const item = document.createElement('li');
      item.className = 'list-group-item';
      item.innerHTML = `<strong>${cliente.nome}</strong> (${cliente.azienda}) - ${cliente.oggetto}, ${cliente.data} <span class="badge bg-info">${cliente.eisenhower}</span>
      <button class="btn btn-sm btn-warning float-end me-2" onclick="modificaCliente(${index})">Modifica</button>
      <button class="btn btn-sm btn-danger float-end me-2" onclick="eliminaCliente(${index})">Elimina</button>`;
      lista.appendChild(item);
    }
  });
}

function eliminaCliente(index) {
  clienti.splice(index, 1);
  aggiornaLista();
  salvaClienti();
}

function modificaCliente(index) {
  const cliente = clienti[index];
  document.getElementById('nomeCliente').value = cliente.nome;
  document.getElementById('aziendaCliente').value = cliente.azienda;
  document.getElementById('oggettoIncontro').value = cliente.oggetto;
  document.getElementById('dataIncontro').value = cliente.data;
  document.getElementById('eisenhower').value = cliente.eisenhower;
  clienti.splice(index, 1);
  aggiornaLista();
  salvaClienti();
}

// Aggiungi cliente

document.getElementById('clienteForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const nuovoCliente = {
    nome: document.getElementById('nomeCliente').value,
    azienda: document.getElementById('aziendaCliente').value,
    oggetto: document.getElementById('oggettoIncontro').value,
    data: document.getElementById('dataIncontro').value,
    eisenhower: document.getElementById('eisenhower').value
  };
  clienti.push(nuovoCliente);
  aggiornaLista();
  salvaClienti();
  this.reset();
});

// Filtri

document.getElementById('ricerca').addEventListener('input', aggiornaLista);
document.getElementById('filtroEisenhower').addEventListener('change', aggiornaLista);

// Carica iniziale
caricaClienti();
</script>
</body>
</html>
